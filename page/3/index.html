<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.jpg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="3Golds">
<meta property="og:url" content="http://zhaodaxin.com/page/3/index.html">
<meta property="og:site_name" content="3Golds">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="3Golds">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zhaodaxin.com/page/3/"/>





  <title>3Golds</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">3Golds</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ThreeGold</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/10/30/2017-10-27-AWS-ELB-502/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/30/2017-10-27-AWS-ELB-502/" itemprop="url">解决 AWS ELB 偶发的 502 Bad Gateway 错误</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-30T00:00:00+08:00">
                2017-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/10/30/2017-10-27-AWS-ELB-502/" class="leancloud_visitors" data-flag-title="解决 AWS ELB 偶发的 502 Bad Gateway 错误">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  550
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>在使用了 <code>Prometheus</code> 做了 HTTP 协议的监控之后，<code>blackbox_exporter</code> 偶尔会报一些 ProbeDown 的报警，经过检查是 502 Bad Gateway 错误，但此时后端是正常的，只是在 AWS ELB 的监控指标中，看到了 ELB HTTP 5xx 相关错误，因此困扰了一段时间。</p>
<p>HTTP 数据流向如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[Client] --- [ELB] --- [nginx] --- [App Servers]</span><br></pre></td></tr></table></figure>
<h3 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h3><p>最开始是怀疑是后端问题，但是查阅了 nginx 和 App servers 的日志，没有任何结果，只是在 ELB 日志里面找到了 502 Bad Gateway 的错误信息。无奈之下甚至怀疑 nginx 所在 EC2 instance 有问题，因此求助了 AWS 技术支持。根据建议，在 nginx 这端做了 tcpdump 抓包，最后终于在 AWS 技术支持的帮助下，定位并解决了问题 🎉。</p>
<p>先补充一个知识：如果后端支持的话，ELB 会使用保持连接（HTTP persistent/keep-alive connections）。来看看这一个保持连接的 TCP stream：</p>
<p><img src="http://obbogqhb1.bkt.clouddn.com/tcp-stream.png" alt="aws 502"><br>其中，<code>10.100.2.186</code> 是 ELB 内部 IP，<code>10.100.250.22</code> 是 nginx 服务器内部 IP。这样，可以看到：</p>
<ul>
<li><p>在 76.69 秒时候，连接被创建；</p>
</li>
<li><p>在 181.69 秒的时候，是最后一次有效请求；</p>
</li>
<li><p>在 256.69 秒的时候（No.7475），该连接被 nginx 关闭；</p>
</li>
<li><p>在 256.69 秒的时候，几乎在同时还有一个 HTTP GET 请求（No.7476）；</p>
</li>
<li><p>由于 nginx 已经关闭连接了，上面的这个请求当然会收到 TCP RST，ELB 无法访问后端服务器，就会返回 502 Bad Gateway 了。</p>
</li>
</ul>
<p>刚刚过了 75 秒（256.69 - 181.69）连接就被 nginx 关闭了，是不是很眼熟：nginx keepalive_timeout 参数的默认值，恰好就是 75 秒。</p>
<p>很明显是遇到了 Keep-Alive timeout race 了，而这个问题其实在 HTTP/1.1 下，是不好解决的，只有靠微调降低出现的概率；禁用 Keep-Alive；或者靠 Client 上层处理。</p>
<h3 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h3><p>由于 ELB 并不受我们的控制，所以考虑对后端进行微调。根据不同的场景，可以：</p>
<ul>
<li><p>增加后端服务器持久连接的保持时间，比如 nginx 增加 keepalive_timeout 参数</p>
</li>
<li><p>减少 ELB 的 idle timeout</p>
</li>
<li><p>禁用 HTTP 持久连接（不推荐）</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/10/27/2017-10-27-Gitlab-omnibus-8.15.1-upgrade-to-9.5.9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/27/2017-10-27-Gitlab-omnibus-8.15.1-upgrade-to-9.5.9/" itemprop="url">Gitlab omnibus 8.15.1 upgrade to 9.5.9</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-27T00:00:00+08:00">
                2017-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/10/27/2017-10-27-Gitlab-omnibus-8.15.1-upgrade-to-9.5.9/" class="leancloud_visitors" data-flag-title="Gitlab omnibus 8.15.1 upgrade to 9.5.9">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,194
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="升级场景"><a href="#升级场景" class="headerlink" title="升级场景"></a>升级场景</h3><p>  由于公司要通过gitlab接入ci和cd功能，经测试一个repo不能正常使用，且gitlab9.5之后增加了很多新功能，比较吸引我们</p>
<ul>
<li><p>GPG Commit Verification: GPG密钥允许您验证签名提交</p>
</li>
<li><p>New Navigation Improvements: 界面窗口有所改进，更便捷和美观，可以在老界面和新界面自由切换</p>
</li>
<li><p>Project Template: 新增了更多的项目模板</p>
</li>
<li><p>Automatic Retry for Failed CI Jobs：自动重试失败的ci job</p>
</li>
<li><p>Automatically Monitor Auto Deployed Apps：自动监控自动部署应用程序</p>
</li>
<li><p>Merge Request Diff File Navigation：查看merge request时更清晰</p>
</li>
</ul>
<p>更多的特性请查阅：<a href="https://about.gitlab.com/2017/08/22/gitlab-9-5-released/" target="_blank" rel="noopener">https://about.gitlab.com/2017/08/22/gitlab-9-5-released/</a></p>
<h3 id="考虑的点及问题"><a href="#考虑的点及问题" class="headerlink" title="考虑的点及问题"></a>考虑的点及问题</h3><ul>
<li><p>1.postgresql版本问题： 由于我们公司使用的是外部的postgresql和redis，postgresql的版本为9.3，而gitlab9.5.9依赖postgresql 9.6以上的版本，所以在升级gitlab的时候他会升级数据库，但是我们是外部的(AWS RDS)，所以他并不能升级，会抛出异常。</p>
</li>
<li><p>2.postgresql的表结构问题：在升级期间，由于版本变化比较大，所以会涉及表结构及表字段的更改，如果使用外部的postgresql，可能会导致不成功</p>
</li>
<li><p>3.gitlab有可能升级失败，失败后必须理解还原，且不影响线上数据</p>
</li>
</ul>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>根据上述问题，新启动一台实例，首先保持和线上的版本相同，其次将线上的数据还原到这台实例，然后在将新启动的实例进行升级，不过在这其中有几个点必须注意：</p>
<ul>
<li><p>1.新启动的实例必须使用本地的postgresql和redis</p>
</li>
<li><p>2.必须将线上的postgresql的数据还原到当前实例的postgresql</p>
</li>
<li><p>3.当前实例上面的psql和pg_dump工具必须和线上版本保持一致(AWS RDS POSTGRESQL)</p>
</li>
<li><p>4.在测试期间，绝对不能和线上使用同一个redis，必须保持redis只有一个connect</p>
</li>
<li><p>5.在gitlab还原数据的时候，其必须在running状态</p>
</li>
</ul>
<h3 id="实施步骤"><a href="#实施步骤" class="headerlink" title="实施步骤"></a>实施步骤</h3><h4 id="一、新实例安装线上同版本gitlab"><a href="#一、新实例安装线上同版本gitlab" class="headerlink" title="一、新实例安装线上同版本gitlab"></a>一、新实例安装线上同版本gitlab</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span><br><span class="line"></span><br><span class="line">$ sudo yum install gitlab-ce-8.15.1-ce.0.el7.x86_64 -y</span><br></pre></td></tr></table></figure>
<h4 id="二、初始化新实例的gitlab"><a href="#二、初始化新实例的gitlab" class="headerlink" title="二、初始化新实例的gitlab"></a>二、初始化新实例的gitlab</h4><p>修改配置文件，修改<code>external_url</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo vim /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line">external_url &apos;http://git.test.com&apos;</span><br><span class="line"></span><br><span class="line">$ sudo gitlab-ctl reconfigure</span><br><span class="line"></span><br><span class="line"># 成功后，通过域名映射来访问(注意，这里如果没有增加dns记录，需要添加hosts)</span><br></pre></td></tr></table></figure>
<h4 id="三、还原postgresql和git-data，与线上保持一致"><a href="#三、还原postgresql和git-data，与线上保持一致" class="headerlink" title="三、还原postgresql和git-data，与线上保持一致"></a>三、还原<code>postgresql</code>和<code>git-data</code>，与线上保持一致</h4><p><strong>还原postgresql</strong></p>
<p>1.清除当前实例pgsql的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ gitlab-psql -h /var/opt/gitlab/postgresql -d template1</span><br><span class="line"></span><br><span class="line">template1=&gt; DROP DATABASE gitlabhq_production;</span><br><span class="line"></span><br><span class="line">DROP</span><br><span class="line"></span><br><span class="line">template1=&gt; CREATE DATABASE gitlabhq_production WITH TEMPLATE = template0 ENCODING = &apos;UTF8&apos; LC_COLLATE = &apos;en_US.UTF-8&apos; LC_CTYPE = &apos;en_US.UTF-8&apos;;</span><br><span class="line"></span><br><span class="line">CREATE</span><br><span class="line"></span><br><span class="line">template1=&gt; ALTER DATABASE gitlabhq_production OWNER TO gitlab;</span><br><span class="line"></span><br><span class="line">ALTER</span><br></pre></td></tr></table></figure>
<p>2.还原线上数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ pg_dump -U gitlab -h HOST -p 5432 gitlabhq_production &gt; gitlabhq_production.sql</span><br><span class="line"></span><br><span class="line">$ gitlab-psql -h /var/opt/gitlab/postgresql -d gitlabhq_production &lt; gitlabhq_production.sql</span><br></pre></td></tr></table></figure>
<p><strong>还原Gitlab data</strong></p>
<p>1.首先下载备份文件，我这里保存在s3上面，所以从s3直接下载,如果<code>没有</code>可以执行下面的命令先进行备份，如果有请忽略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo gitlab-rake gitlab:backup:create SKIP=db  # // 如果有备份不需要执行 //</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ aws s3 cp s3://git-bak/1505322888_2017_10_27_gitlab_backup.tar .</span><br><span class="line"></span><br><span class="line">$ cp 1505322888_2017_10_27_gitlab_backup.tar /var/opt/gitlab/backups/</span><br></pre></td></tr></table></figure>
<p>2.进行还原</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo gitlab-rake gitlab:backup:restore SKIP=db BACKUP=1505322888_2017_09_14_gitlab_backup.tar</span><br></pre></td></tr></table></figure>
<p>3.重新配置并访问查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>
<h4 id="四、对当前实例Gitlab进行升级"><a href="#四、对当前实例Gitlab进行升级" class="headerlink" title="四、对当前实例Gitlab进行升级"></a>四、对当前实例Gitlab进行升级</h4><p><strong>1.通过yum升级</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sudo yum install gitlab-ce-9.5.9-ce.0.el7.x86_64 -y</span><br></pre></td></tr></table></figure>
<p><strong>2.访问正常后，将当前实例的数据导出</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sudo -u gitlab-psql pg_dump -h /var/opt/gitlab/postgresql -U gitlab-psql gitlabhq_production &gt; /tmp/gitlab.sql</span><br></pre></td></tr></table></figure>
<p><strong>3.导入到线上的新postgresql(AWS RDS 9.6+)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">psql -U gitlab -h HOST -p 5432 -d gitlabhq_production &lt; gitlabhq_production.sql</span><br></pre></td></tr></table></figure>
<p><strong>4.修改gitlab配置，配置pgsql及nginx等</strong></p>
<p>注意，修改后为https，需要增加证书。禁用默认的pgsql及prometheus等(如果需要可以开启)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo vim /etc/gitlab/gitlab.rb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">external_url &apos;https://git.test.com&apos;</span><br><span class="line"></span><br><span class="line">nginx[&apos;redirect_http_to_https&apos;] = true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;time_zone&apos;] = &apos;Asia/Shanghai&apos;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;smtp_enable&apos;] = true</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;smtp_address&apos;] = &quot;xxx.xxx.com&quot;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;smtp_port&apos;] = 25</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;smtp_user_name&apos;] = &quot;xxx&quot;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;smtp_password&apos;] = &quot;xxx&quot;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;smtp_authentication&apos;] = &quot;login&quot;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;gitlab_email_from&apos;] = &apos;xxx@xxx.com&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;db_adapter&apos;] = &apos;postgresql&apos;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;db_encoding&apos;] = &apos;utf8&apos;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;db_host&apos;] = &apos;HOST&apos;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;db_port&apos;] = &apos;5432&apos;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;db_username&apos;] = &apos;gitlab&apos;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;db_password&apos;] = &apos;xxxxxx&apos;</span><br><span class="line"></span><br><span class="line">postgresql[&apos;enable&apos;] = false</span><br><span class="line"></span><br><span class="line">redis[&apos;enable&apos;] = false</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;redis_host&apos;] = &apos;xxxx.qm7fjs.ng.0001.cnn1.cache.amazonaws.com.cn&apos;</span><br><span class="line"></span><br><span class="line">gitlab_rails[&apos;redis_port&apos;] = 6379</span><br><span class="line"></span><br><span class="line">nginx[&apos;enable&apos;] = true</span><br><span class="line"></span><br><span class="line">nginx[&apos;ssl_certificate&apos;] = &apos;/etc/gitlab/ssl/xxx.com.chain.crt&apos;</span><br><span class="line"></span><br><span class="line">nginx[&apos;ssl_certificate_key&apos;] = &apos;/etc/gitlab/ssl/xxx.com.key&apos;</span><br><span class="line"></span><br><span class="line">node_exporter[&apos;enable&apos;] = false</span><br><span class="line"></span><br><span class="line">prometheus_monitoring[&apos;enable&apos;] = false</span><br></pre></td></tr></table></figure>
<p><strong>5.重新配置gitlab</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>
<p><strong>6.重新访问，并确认成功</strong><br><img src="http://obbogqhb1.bkt.clouddn.com/gitlab-1.png" alt="gitlab-1.png"><br><img src="http://obbogqhb1.bkt.clouddn.com/gitlab-2.png" alt="gitlab-2.png"><br><img src="http://obbogqhb1.bkt.clouddn.com/gitlab-3.png" alt="gitlab-3.png"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/06/09/2017-06-09-七个对我最重要的职业建议-译文/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/09/2017-06-09-七个对我最重要的职业建议-译文/" itemprop="url">七个对我最重要的职业建议-译文</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-09T00:00:00+08:00">
                2017-06-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/09/2017-06-09-七个对我最重要的职业建议-译文/" class="leancloud_visitors" data-flag-title="七个对我最重要的职业建议-译文">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,288
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="七个对我最重要的职业建议（译文）"><a href="#七个对我最重要的职业建议（译文）" class="headerlink" title="七个对我最重要的职业建议（译文）"></a>七个对我最重要的职业建议（译文）</h3><p>作者： 阮一峰</p>
<p>日期： 2015年9月18日</p>
<p>Nicholas C. Zakas 是全世界最著名的 JavaScript 程序员之一。</p>
<p>两年前，他写了一篇<a href="https://www.nczonline.net/blog/2013/10/15/the-best-career-advice-ive-received/" target="_blank" rel="noopener">长文</a>，回顾自己的职业生涯，提到七个对他来说最重要的建议。</p>
<p>我读完很受启发，决定做一点摘录。你可以先读下面的精简版，再去读全文。</p>
<h3 id="七个对我最好的职业建议（精简版）"><a href="#七个对我最好的职业建议（精简版）" class="headerlink" title="七个对我最好的职业建议（精简版）"></a>七个对我最好的职业建议（精简版）</h3><p>作者：Nicholas C. Zakas</p>
<p>译者：阮一峰</p>
<p>原文网址：<a href="https://www.nczonline.net/blog/2013/10/15/the-best-career-advice-ive-received/" target="_blank" rel="noopener">https://www.nczonline.net/blog/2013/10/15/the-best-career-advice-ive-received/</a></p>
<h4 id="一、不要别人点什么，就做什么"><a href="#一、不要别人点什么，就做什么" class="headerlink" title="一、不要别人点什么，就做什么"></a>一、不要别人点什么，就做什么</h4><p>我的第一份工作，只干了8个月，那家公司就倒闭了。我问经理，接下来我该怎么办，他说：</p>
<blockquote>
<p>“小伙子，千万不要当一个被人点菜的厨师，别人点什么，你就烧什么。不要接受那样一份工作，别人下命令你该干什么，以及怎么干。你要去一个地方，那里的人肯定你对产品的想法，相信你的能力，放手让你去做。”</p>
</blockquote>
<p>我从此明白，单单实现一个产品是不够的，你还必须参与决定怎么实现。好的工程师并不仅仅服从命令，而且还给出反馈，帮助产品的拥有者改进它。</p>
<h4 id="二、推销自己"><a href="#二、推销自己" class="headerlink" title="二、推销自己"></a>二、推销自己</h4><p>我进入雅虎公司以后，经理有一天跟我谈话，他觉得我还做得不够。</p>
<blockquote>
<p>“你工作得很好，代码看上去不错，很少出Bug。但是，问题是别人都没看到这一点。为了让其他人相信你，你必须首先让别人知道你做了什么。你需要推销自己，引起别人的注意。”</p>
</blockquote>
<p>我这才意识到，即使做出了很好的工作，别人都不知道，也没用。做一个角落里静静编码的工程师，并不可取。你的主管会支持你，但是他没法替你宣传。公司的其他人需要明白你的价值，最好的办法就是告诉别人你做了什么。一封简单的Email：”嗨，我完成了XXX，欢迎将你的想法告诉我”，就很管用。</p>
<h4 id="三、学会带领团队"><a href="#三、学会带领团队" class="headerlink" title="三、学会带领团队"></a>三、学会带领团队</h4><p>工作几年后，已经没人怀疑我的技术能力了，大家知道我能写出高质量的可靠代码。有一次，我问主管，怎么才能得到提升，他说：</p>
<blockquote>
<p>“当你的技术能力过关以后，就要考验你与他人相处的能力了。”</p>
</blockquote>
<p>于是，我看到了，自己缺乏的是领导能力，如何带领一个团队，有效地与其他人协同工作，取到更大的成果。</p>
<h4 id="四、生活才是最重要的"><a href="#四、生活才是最重要的" class="headerlink" title="四、生活才是最重要的"></a>四、生活才是最重要的</h4><p>有一段时间，我在雅虎公司很有挫折感，对公司的一些做法不认同，经常会对别人发火。我问一个同事，他怎么能对这种事情保持平静，他回答：</p>
<blockquote>
<p>“你要想通，这一切并不重要。有人提交了烂代码，网站下线了，又怎么样？工作并不是你的整个生活。它们不是真正的问题，只是工作上的问题。真正重要的事情都发生在工作以外。我回到家，家里人正在等我，这才重要啊。”</p>
</blockquote>
<p>从此，我就把工作和生活分开了，只把它当作”工作问题”看待。这样一来，我对工作就总能心平气和，与人交流也更顺利了。</p>
<h4 id="五、自己找到道路"><a href="#五、自己找到道路" class="headerlink" title="五、自己找到道路"></a>五、自己找到道路</h4><p>我被提升为主管以后，不知道该怎么做。我请教了上级，他回答：</p>
<blockquote>
<p>“以前都是我们告诉你做什么，从现在开始，你必须自己回答这个问题了，我期待你来告诉我，什么事情需要做。”</p>
</blockquote>
<p>很多工程师都没有完成这个转变，如果能够做到，可能就说明你成熟了，学会了取舍。你不可能把时间花在所有事情上面，必须找到一个重点。</p>
<h4 id="六、把自己当成主人"><a href="#六、把自己当成主人" class="headerlink" title="六、把自己当成主人"></a>六、把自己当成主人</h4><p>我每天要开很多会，有些会议我根本无话可说。我对一个朋友说，我不知道自己为什么要参加这个会，也没有什么可以贡献，他说：</p>
<blockquote>
<p>“不要再去开这样的会了。你参加一个会，那是因为你参与了某件事。如果不确定自己为什么要在场，就停下来问。如果这件事不需要你，就离开。不要从头到尾都静静地参加一个会，要把自己当成负责人，大家会相信你的。”</p>
</blockquote>
<p>从那时起，我从没有一声不发地参加会议。我确保只参加那些需要我参加的会议。</p>
<h4 id="七、找到水平更高的人"><a href="#七、找到水平更高的人" class="headerlink" title="七、找到水平更高的人"></a>七、找到水平更高的人</h4><p>最后，让我从自己的经历出发，给我的读者一个建议。</p>
<blockquote>
<p>“找到那些比你水平更高、更聪明的人，尽量和他们在一起，吃饭或者喝咖啡，向他们讨教，了解他们拥有的知识。你的职业，甚至你的生活，都会因此变得更好。”</p>
</blockquote>
<p>（完）</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/06/09/2017-06-09-软技能—代码之外的生存指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/09/2017-06-09-软技能—代码之外的生存指南/" itemprop="url">软技能——代码之外的生存指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-09T00:00:00+08:00">
                2017-06-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/09/2017-06-09-软技能—代码之外的生存指南/" class="leancloud_visitors" data-flag-title="软技能——代码之外的生存指南">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,170
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这本书是在逛知乎的时候发现的，说的神乎其神的，也没多想就买了本，并在一个周六的下午看完了，读的过程倒是很轻松，速度也挺快，因为毕竟是一本励志书，多少有点“鸡汤”。总体来说，这本书可圈可点，有干货，也有“鸡汤”，主要分为职业、自我营销、学习、生产力、理财、健身、精神七大模块，不论是不是码农，取其精华来安利一下自己还是不错的！<br>下面我就谈谈书中一些不错的干货，湿货就自己去慢慢看吧。</p>
<h3 id="一、如何对待上班这件事情？"><a href="#一、如何对待上班这件事情？" class="headerlink" title="一、如何对待上班这件事情？"></a>一、如何对待上班这件事情？</h3><p>把自己当做一个软件企业，把雇主当做企业的一个客户，你应当能够提供某种产品或者服务（把一个想法通过技术手段变成一个产品的能力），不断提升你的服务质量，专注于为某一类客户提供特定的服务，做好自我营销，为更多更优质的雇主服务。</p>
<h3 id="二、如何注意人际关系？"><a href="#二、如何注意人际关系？" class="headerlink" title="二、如何注意人际关系？"></a>二、如何注意人际关系？</h3><p>不是教你搞办公室政治，而是让你在这上面少踩坑。书中有句话比较经典：“一旦你贬低他人，削弱他们的成就感，在某种程度上就如同切断了他们的氧气补给，获得的回馈将完全是抓狂和绝望”。</p>
<ul>
<li><p>所以切记不要贬低他人，而是应该多激励</p>
</li>
<li><p>学会聚精会神地聆听，并指出问题所在以及相关解决方案</p>
</li>
<li><p>在小事情上放弃立场或承认错误有时候能为你赢得意想不到的尊重</p>
</li>
</ul>
<h3 id="三、如何搞定面试？"><a href="#三、如何搞定面试？" class="headerlink" title="三、如何搞定面试？"></a>三、如何搞定面试？</h3><p>作者的观点并不新颖，但是的确这种方式最有效，同时也说明了其他方式的不靠谱！</p>
<ul>
<li><p>找人内推</p>
</li>
<li><p>即便不换工作也要多面试增加面试经验</p>
</li>
</ul>
<h3 id="四、技术做到什么程度？"><a href="#四、技术做到什么程度？" class="headerlink" title="四、技术做到什么程度？"></a>四、技术做到什么程度？</h3><p>是一个方向钻到底，还是什么都搞？一门技术钻的越深，潜在的机会就会越少，但获得这些工作机会的可能性就越大。所以我觉得规划好自己的技术栈很有必要，总体来说一专多能可能会好一些。永远不要陷入对技术的狂热之中，只要明白不同的场景需要不同的技术方案解决就行！</p>
<h3 id="五、如何晋升？"><a href="#五、如何晋升？" class="headerlink" title="五、如何晋升？"></a>五、如何晋升？</h3><ul>
<li><p>承担更多的责任</p>
</li>
<li><p>做了事情要及时反馈给上面，上面不知道一切都是徒劳</p>
</li>
<li><p>提升自己的技能</p>
</li>
<li><p>不是提出问题，而是解决问题，相信一切问题都可以解决</p>
</li>
</ul>
<h3 id="六、如何创业？"><a href="#六、如何创业？" class="headerlink" title="六、如何创业？"></a>六、如何创业？</h3><p>要利用业余时间做起来，后期到一定阶段再辞职也不迟，不仅降低了风险，还提高了成功率。</p>
<p>创业要从小处着手，也就是朝着某个独角兽方向发展，比如国内的Face++，就是只做人脸识别算法。</p>
<h3 id="七、技术人员如何自我营销？"><a href="#七、技术人员如何自我营销？" class="headerlink" title="七、技术人员如何自我营销？"></a>七、技术人员如何自我营销？</h3><ul>
<li><p>写博客</p>
</li>
<li><p>社交媒体</p>
</li>
<li><p>演讲、培训别人</p>
</li>
<li><p>写书</p>
</li>
</ul>
<h3 id="八、如何学习？"><a href="#八、如何学习？" class="headerlink" title="八、如何学习？"></a>八、如何学习？</h3><ul>
<li><p>培养自学能力</p>
</li>
<li><p>筛选出重点，快速突破</p>
</li>
<li><p>动手实践才是王道</p>
</li>
</ul>
<h3 id="九、如何管好自己？"><a href="#九、如何管好自己？" class="headerlink" title="九、如何管好自己？"></a>九、如何管好自己？</h3><p>中国的教育模式导致我们基本上都是靠外部因素来左右我们的行为，很少有自我驱动型。良好的生活习惯是自律的有效保证，所以从现在开始让自己的生活变得井然有序，培养起自己的生活习惯！<strong>改掉坏习惯，培养好习惯，把大的目标转换为一个个小的计划！</strong></p>
<h3 id="十、时间去哪了？"><a href="#十、时间去哪了？" class="headerlink" title="十、时间去哪了？"></a>十、时间去哪了？</h3><ul>
<li><p>看手机推送的所谓新闻（实际上都是毫无营养的标题党）</p>
</li>
<li><p>看视频</p>
</li>
<li><p>沉迷于刷社交软件</p>
</li>
</ul>
<h3 id="十一、为何你总是逃避努力工作？"><a href="#十一、为何你总是逃避努力工作？" class="headerlink" title="十一、为何你总是逃避努力工作？"></a>十一、为何你总是逃避努力工作？</h3><p>努力工作——&gt;辛苦——&gt;有价值的东西——&gt;带来的幸福感持久</p>
<p>偷懒——&gt;愉悦——&gt;消费价值的东西——&gt;带来的幸福感短暂</p>
<h3 id="十二、要不要健身？"><a href="#十二、要不要健身？" class="headerlink" title="十二、要不要健身？"></a>十二、要不要健身？</h3><p>每天必须健身，每天必须健身，每天必须健身！</p>
<p>剩下的其他没说的东西要么不是干货，要么不适合中国国情，虽然书名是软技能，但是这些东西从长远来看远胜于技术硬技能本身，这些东西均是在长期的工作生活中潜移默化的，非一日之寒，仅仅知道肯定不行，慢慢践行才是根本，软技能培养好了，自然就转化为了硬技能！</p>
<p>作者：王威</p>
<p>原文：<a href="https://zhuanlan.zhihu.com/p/21926306" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/21926306</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/06/01/2017-06-01-Nginx配置文件安全分析工具Gixy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/01/2017-06-01-Nginx配置文件安全分析工具Gixy/" itemprop="url">Nginx配置文件安全分析工具Gixy</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-01T00:00:00+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/01/2017-06-01-Nginx配置文件安全分析工具Gixy/" class="leancloud_visitors" data-flag-title="Nginx配置文件安全分析工具Gixy">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  419
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Nginx配置文件安全分析工具Gixy"><a href="#Nginx配置文件安全分析工具Gixy" class="headerlink" title="Nginx配置文件安全分析工具Gixy"></a>Nginx配置文件安全分析工具Gixy</h3><p>Gixy是一个分析Nginx配置的工具。Gixy的主要目的是防止安全的错误配置和自动化探伤。</p>
<p>目前支持Python版本2.7和3.5 +。</p>
<p>免责声明:Gixy只在GNU / Linux Gixy测试良好,其他的操作系统可能有问题。</p>
<h4 id="Gixy的特性"><a href="#Gixy的特性" class="headerlink" title="Gixy的特性"></a>Gixy的特性</h4><ul>
<li>找出服务器端请求伪造。</li>
<li>验证HTTP拆分。</li>
<li>验证referrer/origin问题。</li>
<li>验证是否正确通过add_header指令重新定义Response Headers。</li>
<li>验证请求的主机头是否伪造。</li>
<li>验证valid_referers是否为空。</li>
<li>验证是否存在多行主机头。</li>
</ul>
<p>Github地址：<a href="https://github.com/yandex/gixy" target="_blank" rel="noopener">https://github.com/yandex/gixy</a></p>
<h4 id="Gixy安装"><a href="#Gixy安装" class="headerlink" title="Gixy安装"></a>Gixy安装</h4><p>安装步骤很简单，直接使用pip安装即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install gixy</span><br><span class="line"># 注意：目前支持Python版本2.7和3.5 +。</span><br></pre></td></tr></table></figure></p>
<h4 id="Gixy使用"><a href="#Gixy使用" class="headerlink" title="Gixy使用"></a>Gixy使用</h4><p>Gixy默认检查/etc/nginx/nginx.conf文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gixy</span><br></pre></td></tr></table></figure>
<p>可以指定nginx配置文件所在位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ gixy /usr/local//nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">==================== Results ===================</span><br><span class="line"></span><br><span class="line">Problem: [http_splitting] Possible HTTP-Splitting vulnerability.</span><br><span class="line">Description: Using variables that can contain &quot;\n&quot; may lead to http injection.</span><br><span class="line">Additional info: https://github.com/yandex/gixy/blob/master/docs/ru/plugins/httpsplitting.md</span><br><span class="line">Reason: At least variable &quot;$action&quot; can contain &quot;\n&quot;</span><br><span class="line">Pseudo config:</span><br><span class="line">include /etc/nginx/sites/default.conf;</span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line"></span><br><span class="line">		location ~ /v1/((?&lt;action&gt;[^.]*)\.json)?$ &#123;</span><br><span class="line">			add_header X-Action $action;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">==================== Summary ===================</span><br><span class="line">Total issues:</span><br><span class="line">    Unspecified: 0</span><br><span class="line">    Low: 0</span><br><span class="line">    Medium: 0</span><br><span class="line">    High: 1</span><br></pre></td></tr></table></figure>
<p>从结果查看出问题为<code>http_splitting</code>。原因是 $action 变量中可以含有换行符。这就是HTTP响应头拆分漏洞，通过CRLFZ注入实现攻击。</p>
<p>如果你要暂时忽略某类错误，可以使用–skip参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ gixy --skips http_splitting /usr/local/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">==================== Results ===================</span><br><span class="line">No issues found.</span><br><span class="line"></span><br><span class="line">==================== Summary ===================</span><br><span class="line">Total issues:</span><br><span class="line">    Unspecified: 0</span><br><span class="line">    Low: 0</span><br><span class="line">    Medium: 0</span><br><span class="line">    High: 0</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/03/17/2017-03-17-基于amazon-s3创建yum仓库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/17/2017-03-17-基于amazon-s3创建yum仓库/" itemprop="url">基于amazon-s3创建yum仓库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-17T00:00:00+08:00">
                2017-03-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/03/17/2017-03-17-基于amazon-s3创建yum仓库/" class="leancloud_visitors" data-flag-title="基于amazon-s3创建yum仓库">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,569
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="AWS-配置"><a href="#AWS-配置" class="headerlink" title="AWS 配置"></a>AWS 配置</h2><h3 id="1-创建s3-仓库"><a href="#1-创建s3-仓库" class="headerlink" title="1.创建s3 仓库"></a>1.创建s3 仓库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">aws s3 mb s3://yum-repo-s3</span><br><span class="line"></span><br><span class="line">make_bucket: yum-repo-s3</span><br></pre></td></tr></table></figure>
<h3 id="2-创建s3用户"><a href="#2-创建s3用户" class="headerlink" title="2.创建s3用户"></a>2.创建s3用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$~ aws iam create-user --user-name yum-repo-user</span><br></pre></td></tr></table></figure>
<h3 id="3-赋予s3用户权限"><a href="#3-赋予s3用户权限" class="headerlink" title="3.赋予s3用户权限"></a>3.赋予s3用户权限</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ aws iam put-user-policy --user-name yum-repo-user --policy-name yum-repo-s3-Bucket-Access --policy-document file://demo-s3-rpm-repo_policy.json</span><br><span class="line"></span><br><span class="line">$ cat demo-s3-rpm-repo_policy.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line"></span><br><span class="line">  &quot;Statement&quot;: [</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">      &quot;Sid&quot;: &quot;Stmt1489722431765&quot;,</span><br><span class="line"></span><br><span class="line">      &quot;Action&quot;: &quot;s3:*&quot;,</span><br><span class="line"></span><br><span class="line">      &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line"></span><br><span class="line">      &quot;Resource&quot;: &quot;arn:aws-cn:s3:::yum-repo-s3&quot;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-查看其权限"><a href="#4-查看其权限" class="headerlink" title="4.查看其权限"></a>4.查看其权限</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">$ aws iam list-user-policies --user-name yum-repo-user</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &quot;PolicyNames&quot;: [</span><br><span class="line"></span><br><span class="line">        &quot;yum-repo-s3-Bucket-Access&quot;</span><br><span class="line"></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-创建access-key"><a href="#5-创建access-key" class="headerlink" title="5.创建access key"></a>5.创建access key</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ aws iam create-access-key --user-name yum-repo-user</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &quot;AccessKey&quot;: &#123;</span><br><span class="line"></span><br><span class="line">        &quot;UserName&quot;: &quot;yum-repo-user&quot;,</span><br><span class="line"></span><br><span class="line">        &quot;Status&quot;: &quot;Active&quot;,</span><br><span class="line"></span><br><span class="line">        &quot;AccessKeyId&quot;: &quot;KEYID&quot;,</span><br><span class="line"></span><br><span class="line">        &quot;SecretAccessKey&quot;: &quot;SECRET_KEY&quot;,</span><br><span class="line"></span><br><span class="line">        &quot;CreateDate&quot;: &quot;2017-03-17T04:16:55.969Z&quot;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="仓库配置"><a href="#仓库配置" class="headerlink" title="仓库配置"></a>仓库配置</h2><h3 id="1-安装需要的程序包"><a href="#1-安装需要的程序包" class="headerlink" title="1.安装需要的程序包"></a>1.安装需要的程序包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo yum groupinstall &quot;Development Tools&quot; -y</span><br><span class="line"></span><br><span class="line">$ sudo yum install s3cmd --enablerepo=epel -y</span><br><span class="line"></span><br><span class="line">$ sudo yum install createrepo pinentry -y</span><br></pre></td></tr></table></figure>
<h3 id="2-添加用户-此处也可以使用root"><a href="#2-添加用户-此处也可以使用root" class="headerlink" title="2.添加用户(此处也可以使用root)"></a>2.添加用户(此处也可以使用root)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo adduser builder</span><br><span class="line"></span><br><span class="line">$ sudo echo -e &quot;builder\tALL=(ALL) NOPASSWD:ALL&quot;&gt;/etc/sudoers.d/builder</span><br></pre></td></tr></table></figure>
<h3 id="3-配置用户access-key"><a href="#3-配置用户access-key" class="headerlink" title="3.配置用户access key"></a>3.配置用户access key</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ aws configure</span><br><span class="line"></span><br><span class="line">AWS Access Key ID [None]: KEY</span><br><span class="line"></span><br><span class="line">AWS Secret Access Key [None]: SECRET_KEY</span><br><span class="line"></span><br><span class="line">Default region name [None]: cn-north-1</span><br><span class="line"></span><br><span class="line">Default output format [None]: json</span><br></pre></td></tr></table></figure>
<h3 id="4-配置一个专用的Public-Private-GPG密钥对"><a href="#4-配置一个专用的Public-Private-GPG密钥对" class="headerlink" title="4.配置一个专用的Public/Private GPG密钥对"></a>4.配置一个专用的Public/Private GPG密钥对</h3><p><strong>生成一个新的GPG密钥对</strong></p>
<p>这里要等一段时间，他需要从随机数库里面去数字，在此期间可以敲击键盘或者点击鼠标来生成随机数(注意：不要ctrl+c)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">gpg --gen-key</span><br><span class="line"></span><br><span class="line">gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line"></span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line"></span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Please select what kind of key you want:</span><br><span class="line"></span><br><span class="line">   (1) RSA and RSA (default)</span><br><span class="line"></span><br><span class="line">   (2) DSA and Elgamal</span><br><span class="line"></span><br><span class="line">   (3) DSA (sign only)</span><br><span class="line"></span><br><span class="line">   (4) RSA (sign only)</span><br><span class="line"></span><br><span class="line">Your selection?</span><br><span class="line"></span><br><span class="line">RSA keys may be between 1024 and 4096 bits long.</span><br><span class="line"></span><br><span class="line">What keysize do you want? (2048)</span><br><span class="line"></span><br><span class="line">Requested keysize is 2048 bits</span><br><span class="line"></span><br><span class="line">Please specify how long the key should be valid.</span><br><span class="line"></span><br><span class="line">         0 = key does not expire</span><br><span class="line"></span><br><span class="line">      &lt;n&gt;  = key expires in n days</span><br><span class="line"></span><br><span class="line">      &lt;n&gt;w = key expires in n weeks</span><br><span class="line"></span><br><span class="line">      &lt;n&gt;m = key expires in n months</span><br><span class="line"></span><br><span class="line">      &lt;n&gt;y = key expires in n years</span><br><span class="line"></span><br><span class="line">Key is valid for? (0)</span><br><span class="line"></span><br><span class="line">Key does not expire at all</span><br><span class="line"></span><br><span class="line">Is this correct? (y/N) y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GnuPG needs to construct a user ID to identify your key.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Real name: repo-for-me</span><br><span class="line"></span><br><span class="line">Email address: repo@repo.com</span><br><span class="line"></span><br><span class="line">Comment: my repo</span><br><span class="line"></span><br><span class="line">You selected this USER-ID:</span><br><span class="line"></span><br><span class="line">    &quot;repo-for-me (my repo) &lt;repo@repo.com&gt;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o</span><br><span class="line"></span><br><span class="line">You need a Passphrase to protect your secret key.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">We need to generate a lot of random bytes. It is a good idea to perform</span><br><span class="line"></span><br><span class="line">some other action (type on the keyboard, move the mouse, utilize the</span><br><span class="line"></span><br><span class="line">disks) during the prime generation; this gives the random number</span><br><span class="line"></span><br><span class="line">generator a better chance to gain enough entropy.</span><br></pre></td></tr></table></figure>
<p><strong>查看生成的GPG密钥对</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># gpg --list-keys</span><br><span class="line"></span><br><span class="line">/root/.gnupg/pubring.gpg</span><br><span class="line"></span><br><span class="line">------------------------</span><br><span class="line"></span><br><span class="line">pub   2048R/AE355D 2017-03-17</span><br><span class="line"></span><br><span class="line">uid                 repo-for-me (my repo) &lt;repo@repo.com&gt;</span><br><span class="line"></span><br><span class="line">sub   2048R/45DEQAD 2017-03-17</span><br></pre></td></tr></table></figure>
<p><strong>导出public key</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">gpg --output ~/RPM-GPG-KEY-my-repo --armor --export AE355D</span><br></pre></td></tr></table></figure>
<p><strong>导出private key</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">gpg --output ~/RPM-GPG-KEY-my-repo.private --export-secret-key -armor AE355D</span><br></pre></td></tr></table></figure>
<p><strong>rpm 导入key</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rpm --import ~/RPM-GPG-KEY-my-repo</span><br></pre></td></tr></table></figure>
<p><strong>确认被正确安装</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rpm -q gpg-pubkey --qf &apos;%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125; --&gt; %&#123;summary&#125;\n&apos;</span><br><span class="line"></span><br><span class="line">gpg-pubkey-f4a80eb5-53a7ff4b --&gt; gpg(CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;)</span><br><span class="line"></span><br><span class="line">gpg-pubkey-621e9f35-58adea78 --&gt; gpg(Docker Release (CE rpm) &lt;docker@docker.com&gt;)</span><br><span class="line"></span><br><span class="line">gpg-pubkey-4a7cz49d-533129b --&gt; gpg(repo-for-me (my repo) &lt;repo@repo.com&gt;)</span><br></pre></td></tr></table></figure>
<h3 id="5-构建RPM-packages"><a href="#5-构建RPM-packages" class="headerlink" title="5.构建RPM packages"></a>5.构建RPM packages</h3><p><strong>创建rpmbuild目录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mkdir -pv ~/rpmbuild/&#123;BUILD,RPMS,SOURCES,SPECS,SRPMS&#125;</span><br></pre></td></tr></table></figure>
<p><strong>创建一个repo文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ cat ~/repo-for-me.repo</span><br><span class="line"></span><br><span class="line">[repo-for-me]</span><br><span class="line"></span><br><span class="line">name=name=Extra Packages from Celingest Demo S3 RPM Repository - $basearch</span><br><span class="line"></span><br><span class="line">baseurl=https://s3.cn-north-1.amazonaws.com.cn/repo-for-me/yum-repo/$basearch/</span><br><span class="line"></span><br><span class="line">enabled=1</span><br><span class="line"></span><br><span class="line">gpgkey = file:///etc/pki/rpm-gpg/RPM-GPG-KEY-my-repo</span><br><span class="line"></span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure>
<p><strong>配置.spec文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ cat repo-for-me.spec</span><br><span class="line"></span><br><span class="line"># S3 RPM Repository configuration files and GPG key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%define name    repo-for-me</span><br><span class="line"></span><br><span class="line">%define version   1</span><br><span class="line"></span><br><span class="line">%define release   0.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%define buildroot %&#123;_topdir&#125;/%&#123;name&#125;-%&#123;version&#125;-root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BuildArch:  x86_64</span><br><span class="line"></span><br><span class="line">BuildRoot:  %&#123;buildroot&#125;</span><br><span class="line"></span><br><span class="line">Summary:    S3 RPM Repository</span><br><span class="line"></span><br><span class="line">License:    GPLv3</span><br><span class="line"></span><br><span class="line">Name:       %&#123;name&#125;</span><br><span class="line"></span><br><span class="line">Version:    %&#123;version&#125;</span><br><span class="line"></span><br><span class="line">Release:    %&#123;release&#125;</span><br><span class="line"></span><br><span class="line">Group:      Development/Tools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%description</span><br><span class="line"></span><br><span class="line">Package containing antony amzon S3 RPM Repository configuration files and GPG key.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%prep</span><br><span class="line"></span><br><span class="line">exit 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%build</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%install</span><br><span class="line"></span><br><span class="line">rm -rf $RPM_BUILD_ROOT</span><br><span class="line"></span><br><span class="line">mkdir -p $RPM_BUILD_ROOT%&#123;_sysconfdir&#125;/yum.repos.d/</span><br><span class="line"></span><br><span class="line">mkdir -p $RPM_BUILD_ROOT%&#123;_sysconfdir&#125;/pki/rpm-gpg/</span><br><span class="line"></span><br><span class="line">cp -p ~/repo-for-me.repo $RPM_BUILD_ROOT%&#123;_sysconfdir&#125;/yum.repos.d/</span><br><span class="line"></span><br><span class="line">cp -p ~/RPM-GPG-KEY-my-repo $RPM_BUILD_ROOT%&#123;_sysconfdir&#125;/pki/rpm-gpg/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%clean</span><br><span class="line"></span><br><span class="line">rm -rf $RPM_BUILD_ROOT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%files</span><br><span class="line"></span><br><span class="line">%defattr(-,root,root,-)</span><br><span class="line"></span><br><span class="line">/etc/yum.repos.d/repo-for-me.repo</span><br><span class="line"></span><br><span class="line">/etc/pki/rpm-gpg/RPM-GPG-KEY-my-repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%changelog</span><br><span class="line"></span><br><span class="line">* Fri Mar 17 2017 Builder &lt;my@my.repo.com&gt; 1.0.1</span><br><span class="line"></span><br><span class="line">- First release.</span><br></pre></td></tr></table></figure>
<p><strong>配置rpm macros</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat .rpmmacros</span><br><span class="line"></span><br><span class="line">%_signature gpg</span><br><span class="line"></span><br><span class="line">%_gpg_path /root/.gnupg</span><br><span class="line"></span><br><span class="line">%_gpg_name repo-for-me (my repo) &lt;repo@repo.com&gt; # 此处的名字通过# gpg --list-keys 查看uid</span><br><span class="line"></span><br><span class="line">%_gpgbin /usr/bin/gpg</span><br><span class="line"></span><br><span class="line">%packager meiqia &lt;repo@repo.com&gt;</span><br><span class="line"></span><br><span class="line">%_topdir /root/rpmbuild</span><br></pre></td></tr></table></figure>
<p><strong>制作rpm</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rpmbuild -v -ba --sign --clean repo-for-me.spec</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Enter pass phrase:  #这里的密码是gpg --gen-key生成的密码</span><br><span class="line"></span><br><span class="line">Pass phrase is good.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/home/root/rpmbuild/SRPMS/repo-for-me-1-0.1.x86_64.rpm</span><br><span class="line"></span><br><span class="line">/home/root/rpmbuild/RPMS/noarch/repo-for-me-1-0.1.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p><strong>检查包的正确性</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rpm --checksig /home/builder/rpmbuild/SRPMS/repo-for-me-1-0.1.x86_64.rpm</span><br><span class="line"></span><br><span class="line">/root/rpmbuild/RPMS/repo-for-me-1-0.1.x86_64.rpm: rsa sha1 (md5) pgp md5 ok</span><br></pre></td></tr></table></figure>
<h3 id="更新到s3"><a href="#更新到s3" class="headerlink" title="更新到s3"></a>更新到s3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mkdir -pv ~/yum-repo/&#123;x86_64,noarch&#125; # 注意 yum-repo这个目录必须和repo文件中的一一对应</span><br></pre></td></tr></table></figure>
<p><strong>拷贝rpm包到/yum-repo/x86_64</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cp /home/root/rpmbuild/SRPMS/*.rpm ~/yum-repo/x86-64</span><br></pre></td></tr></table></figure>
<p><strong>创建metadata file（最重要的一步）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">for a in /root/repo-for-me/x86_64; do createrepo -v --update --deltas $a/ ; done</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>上传到s3</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">aws s3 sync yum-repo/ s3://repo-for-me/yum-repo/</span><br></pre></td></tr></table></figure>
<p><strong>安装并测试</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rpm -ivh https://s3.cn-north-1.amazonaws.com.cn/repo-for-me/yum-repo/x86_64/tools/repo-for-me-1-0.1.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p><strong>本文主要介绍如何管理仓库，如制作rpm包、创建依赖关系、上传rpm到s3等，如果想了解实现方式，请查阅：<a href="http://wiki.meiqia.com/pages/viewpage.action?pageId=5701661" target="_blank" rel="noopener">repo-for-s3</a></strong></p>
<h3 id="公开s3"><a href="#公开s3" class="headerlink" title="公开s3"></a>公开s3</h3><p><img src="http://obbogqhb1.bkt.clouddn.com/yum-s3.png" alt="s3-yum"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/03/16/2017-03-16-docker1.13+版本FORWARD链为DROP的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/16/2017-03-16-docker1.13+版本FORWARD链为DROP的问题/" itemprop="url">docker 1.13+ FORWARD链为DROP的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-16T00:00:00+08:00">
                2017-03-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/03/16/2017-03-16-docker1.13+版本FORWARD链为DROP的问题/" class="leancloud_visitors" data-flag-title="docker 1.13+ FORWARD链为DROP的问题">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  425
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="本地网络容器访问漏洞"><a href="#本地网络容器访问漏洞" class="headerlink" title="本地网络容器访问漏洞"></a>本地网络容器访问漏洞</h3><p>这个问题出现在docker的<a href="https://github.com/docker/docker/issues/14041" target="_blank" rel="noopener">issue</a>中</p>
<p>其主要影响：允许与docker主机位于同一网络上的任何人访问在该主机上运行的容器，而不是只访问暴露的端口。</p>
<p>当docker启动时，它启用net.ipv4.ip_forward而不改变iptables FORWARD链默认策略DROP。这意味着与docker主机位于同一网络上的另一台机器可以向其路由表添加路由，并直接寻址在该docker主机上运行的任何容器。</p>
<p><strong>例如，如果docker0子网是172.17.0.0/16（默认子网），并且docker主机的IP地址是192.168.0.10，则从网络上的另一个主机运行：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ip route add 172.17.0.0/16 via 192.168.0.10</span><br><span class="line"></span><br><span class="line">nmap 172.17.0.0/16</span><br></pre></td></tr></table></figure>
<p>上面将扫描主机上运行的容器，并报告找到的IP地址和运行的服务。</p>
<p>要解决这个问题，docker需要将FORWARD策略设置为DROP启用net.ipv4.ip_forwardsysctl参数。</p>
<h3 id="带来的其他问题"><a href="#带来的其他问题" class="headerlink" title="带来的其他问题"></a>带来的其他问题</h3><p>带来的问题主要出现在docker 配合kubernetes使用时，kubernetes的网络使用flannel，flannel可以使不同主机间的容器通信。如下图</p>
<p><img src="http://obbogqhb1.bkt.clouddn.com/docker-bug.png" alt="docker-forward-drop"></p>
<p>但是带来的问题是：一旦DROP后，不同主机间就不能正常通信了，为了保证其能正常通信，可以选择三种方案。</p>
<h4 id="1-将FORWARD改为ACCEPT"><a href="#1-将FORWARD改为ACCEPT" class="headerlink" title="1.将FORWARD改为ACCEPT"></a>1.将FORWARD改为ACCEPT</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line">这种方式不适合重启，一重启就需要修改</span><br></pre></td></tr></table></figure>
<h4 id="2-仅允许flannel网段"><a href="#2-仅允许flannel网段" class="headerlink" title="2.仅允许flannel网段"></a>2.仅允许flannel网段</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ iptables -I FORWARD -s 172.1.0.0/16 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h4 id="3-在-usr-lib-systemd-system-docker-service中添加"><a href="#3-在-usr-lib-systemd-system-docker-service中添加" class="headerlink" title="3.在/usr/lib/systemd/system/docker.service中添加"></a>3.在/usr/lib/systemd/system/docker.service中添加</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[Service] #在这下面添加</span><br><span class="line"></span><br><span class="line">ExecStartPost=/sbin/iptables -I FORWARD -s 0.0.0.0/0 -j ACCEPT</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/03/15/2017-03-15-Docker-社区和企业版出现了/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/15/2017-03-15-Docker-社区和企业版出现了/" itemprop="url">Docker 社区和企业版出现了</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-15T00:00:00+08:00">
                2017-03-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/03/15/2017-03-15-Docker-社区和企业版出现了/" class="leancloud_visitors" data-flag-title="Docker 社区和企业版出现了">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  911
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Docker-社区和企业版出现了"><a href="#Docker-社区和企业版出现了" class="headerlink" title="Docker 社区和企业版出现了"></a>Docker 社区和企业版出现了</h3><p>今天早上去官网看文档，一进去发现主页变了，映入眼帘的便是：join us at Dockercon, April 17,2017。一脸蒙蔽的我往下翻了翻，发现做了这么久的解决方案，docker企业版都支持，但是收费！！！！而且，Dockercon是什么鬼？</p>
<p><img src="http://obbogqhb1.bkt.clouddn.com/docker1.png" alt="docker"></p>
<p>当然，docker也被分为两个版本：</p>
<ul>
<li><p>community-edition</p>
</li>
<li><p>enterprise-edition</p>
</li>
</ul>
<h3 id="dockercon社区"><a href="#dockercon社区" class="headerlink" title="dockercon社区"></a>dockercon社区</h3><p>docker 官网公布了一个社区，目前还没有开放，其域名是:<a href="http://2017.dockercon.com/" target="_blank" rel="noopener">2017.dockercon.com</a></p>
<p>docker社区将在2017年4月17号开始使用，现在可以去注册了。</p>
<p><img src="http://obbogqhb1.bkt.clouddn.com/docker2.png" alt="docker"></p>
<h3 id="Docker-CE和EE的区别及定价"><a href="#Docker-CE和EE的区别及定价" class="headerlink" title="Docker CE和EE的区别及定价"></a>Docker CE和EE的区别及定价</h3><p>参照：<a href="https://www.docker.com/pricing" target="_blank" rel="noopener">https://www.docker.com/pricing</a></p>
<p><img src="http://obbogqhb1.bkt.clouddn.com/docker-table.png" alt="docker"></p>
<h3 id="Docker-EE（企业版）详细介绍"><a href="#Docker-EE（企业版）详细介绍" class="headerlink" title="Docker EE（企业版）详细介绍"></a>Docker EE（企业版）详细介绍</h3><blockquote>
<p>Docker企业版（EE）专为企业开发和IT团队设计，可在大规模生产中构建，运送和运行关键业务应用程序。Docker EE集成，认证和支持，为企业提供业界最安全的容器平台，实现所有应用程序的现代化。作为一个以应用为中心的平台，Docker EE旨在加速和保护整个软件供应链，从开发到在任何基础设施上运行的生产。</p>
</blockquote>
<h4 id="平台"><a href="#平台" class="headerlink" title="平台"></a>平台</h4><p><img src="http://obbogqhb1.bkt.clouddn.com/docker3.png" alt="docker"></p>
<h4 id="信任和认证"><a href="#信任和认证" class="headerlink" title="信任和认证"></a>信任和认证</h4><blockquote>
<p>Docker EE为在企业Linux或Windows操作系统和云提供商上运行的应用程序提供集成，测试和认证的平台。Docker EE紧密集成到底层基础架构，以提供本机，易于安装的体验和优化的Docker环境。Docker认证的基础架构，容器和插件专用于Docker EE，由Docker和认证技术合作伙伴提供合作支持。</p>
</blockquote>
<ul>
<li><p><strong>认证基础</strong>设施为企业Linux（CentOS，Oracle Linux，RHEL，SLES，Ubuntu）提供集成环境Windows Server 2016和云提供商如AWS和Azure</p>
</li>
<li><p><strong>认证容器</strong>提供可信的ISV产品打包和分发为Docker容器，提供最佳实践和最安全的构建</p>
</li>
<li><p><strong>认证插件</strong>提供网络和volume插件，并且易于下载和安装容器到Docker EE环境。</p>
</li>
</ul>
<h4 id="使用Docker数据中心的集成容器管理"><a href="#使用Docker数据中心的集成容器管理" class="headerlink" title="使用Docker数据中心的集成容器管理"></a>使用Docker数据中心的集成容器管理</h4><blockquote>
<p>Docker Datacenter现在是Docker EE的一部分，提供集成容器管理和安全从开发到生产。企业版准备了诸多功能，例如multi-tenancy,security和full support for Docker API给IT团队。开放接口允许轻松集成到现有系统中，并且灵活地支持任何一系列业务流程。</p>
</blockquote>
<ul>
<li><p>从单个Web管理UI集成管理所有应用程序资源</p>
</li>
<li><p>通过几次点击，将应用程序和撰写文件无缝部署到生产环境中</p>
</li>
<li><p>具有基于角色的访问控制（RBAC）和LDAP / AD集成的多租户系统</p>
</li>
<li><p>自我修复应用程序部署，能够应用滚动应用程序更新</p>
</li>
<li><p>端到端的安全模型与秘密管理，图像签名和图像安全扫描</p>
</li>
<li><p>打开和可扩展到现有的企业系统和过程</p>
</li>
</ul>
<h4 id="更安全的应用程序与Docker-EE"><a href="#更安全的应用程序与Docker-EE" class="headerlink" title="更安全的应用程序与Docker EE"></a>更安全的应用程序与Docker EE</h4><blockquote>
<p>安全不是静态的。现代应用程序是动态的，需要为应用程序定义的安全模型，而不是基础结构。Docker EE提供了一个集成的安全框架，提供更强的默认安全性，可以灵活地更改配置和标准化接口，以便开发人员和IT轻松协作。从安全的环境，通信和应用程序本身，Docker EE为企业提供更安全的应用程序。</p>
</blockquote>
<p><img src="http://obbogqhb1.bkt.clouddn.com/docker4.png" alt="docker"></p>
<h4 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h4><p>docker EE功能确实强大，不过开始不太稳定。开源软件一样可以实现，只是需要花点时间罢了！ 当然，如果有强烈需求，建议与docker一起做上docker的大轮船。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/02/20/2017-02-20-Cow-rc-样例配置文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/20/2017-02-20-Cow-rc-样例配置文件/" itemprop="url">Cow-rc-样例配置文件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-20T00:00:00+08:00">
                2017-02-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/02/20/2017-02-20-Cow-rc-样例配置文件/" class="leancloud_visitors" data-flag-title="Cow-rc-样例配置文件">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,624
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"># 配置文件中 # 开头的行为注释</span><br><span class="line">#</span><br><span class="line"># 代理服务器监听地址，重复多次来指定多个监听地址，语法：</span><br><span class="line">#</span><br><span class="line">#   listen = protocol://[optional@]server_address:server_port</span><br><span class="line">#</span><br><span class="line"># 支持的 protocol 如下：</span><br><span class="line">#</span><br><span class="line"># HTTP (提供 http 代理):</span><br><span class="line">#   listen = http://127.0.0.1:7777</span><br><span class="line">#</span><br><span class="line">#   上面的例子中，cow 生成的 PAC url 为 http://127.0.0.1:7777/pac</span><br><span class="line">#   配置浏览器或系统 HTTP 和 HTTPS 代理时请填入该地址</span><br><span class="line">#   若配置代理时有对所有协议使用该代理的选项，且你不清楚此选项的含义，请勾选</span><br><span class="line">#</span><br><span class="line"># cow (需两个 cow 服务器配合使用):</span><br><span class="line">#   listen = cow://encrypt_method:password@1.2.3.4:5678</span><br><span class="line">#</span><br><span class="line">#   若 1.2.3.4:5678 在国外，位于国内的 cow 配置其为二级代理后，两个 cow 之间可以</span><br><span class="line">#   通过加密连接传输 http 代理流量。目前的加密采用与 shadowsocks 相同的方式。</span><br><span class="line">#</span><br><span class="line"># 其他说明：</span><br><span class="line"># - 若 server_address 为 0.0.0.0，监听本机所有 IP 地址</span><br><span class="line"># - 可以用如下语法指定 PAC 中返回的代理服务器地址（当使用端口映射将 http 代理提供给外网时使用）</span><br><span class="line">#   listen = http://127.0.0.1:7777 1.2.3.4:5678</span><br><span class="line">#</span><br><span class="line">listen = http://127.0.0.1:7777</span><br><span class="line"></span><br><span class="line"># 日志文件路径，如不指定则输出到 stdout</span><br><span class="line">#logFile =</span><br><span class="line"></span><br><span class="line"># COW 默认仅对被墙网站使用二级代理</span><br><span class="line"># 下面选项设置为 true 后，所有网站都通过二级代理访问</span><br><span class="line">#alwaysProxy = false</span><br><span class="line"></span><br><span class="line"># 指定多个二级代理时使用的负载均衡策略，可选策略如下</span><br><span class="line">#</span><br><span class="line">#   backup:  默认策略，优先使用第一个指定的二级代理，其他仅作备份使用</span><br><span class="line">#   hash:    根据请求的 host name，优先使用 hash 到的某一个二级代理</span><br><span class="line">#   latency: 优先选择连接延迟最低的二级代理</span><br><span class="line">#</span><br><span class="line"># 一个二级代理连接失败后会依次尝试其他二级代理</span><br><span class="line"># 失败的二级代理会以一定的概率再次尝试使用，因此恢复后会重新启用</span><br><span class="line">#loadBalance = backup</span><br><span class="line"></span><br><span class="line">#############################</span><br><span class="line"># 指定二级代理</span><br><span class="line">#############################</span><br><span class="line"></span><br><span class="line"># 二级代理统一使用下列语法指定：</span><br><span class="line">#</span><br><span class="line">#   proxy = protocol://[authinfo@]server:port</span><br><span class="line">#</span><br><span class="line"># 重复使用 proxy 多次指定多个二级代理，backup 策略将按照二级代理出现的顺序来使用</span><br><span class="line">#</span><br><span class="line"># 目前支持的二级代理及配置举例：</span><br><span class="line">#</span><br><span class="line"># SOCKS5:</span><br><span class="line">#   proxy = socks5://127.0.0.1:1080</span><br><span class="line">#</span><br><span class="line"># HTTP:</span><br><span class="line">#   proxy = http://127.0.0.1:8080</span><br><span class="line">#   proxy = http://user:password@127.0.0.1:8080</span><br><span class="line">#</span><br><span class="line">#   用户认证信息为可选项</span><br><span class="line">#</span><br><span class="line"># shadowsocks:</span><br><span class="line">#   proxy = ss://encrypt_method:password@1.2.3.4:8388</span><br><span class="line">#   proxy = ss://encrypt_method-auth:password@1.2.3.4:8388</span><br><span class="line">#</span><br><span class="line">#   encrypt_method 添加 -auth 启用 One Time Auth</span><br><span class="line">#   authinfo 中指定加密方法和密码，所有支持的加密方法如下：</span><br><span class="line">#     aes-128-cfb, aes-192-cfb, aes-256-cfb,</span><br><span class="line">#     bf-cfb, cast5-cfb, des-cfb, rc4-md5,</span><br><span class="line">#     chacha20, salsa20, rc4, table</span><br><span class="line">#   推荐使用 aes-128-cfb</span><br><span class="line">#</span><br><span class="line"># cow:</span><br><span class="line">#   proxy = cow://method:passwd@1.2.3.4:4321</span><br><span class="line">#</span><br><span class="line">#   authinfo 与 shadowsocks 相同</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#############################</span><br><span class="line"># 执行 ssh 命令创建 SOCKS5 代理</span><br><span class="line">#############################</span><br><span class="line"></span><br><span class="line"># 下面的选项可以让 COW 执行 ssh 命令创建本地 SOCKS5 代理，并在 ssh 断开后重连</span><br><span class="line"># COW 会自动使用通过 ssh 命令创建的代理，无需再通过 proxy 选项指定</span><br><span class="line"># 可重复指定多个</span><br><span class="line">#</span><br><span class="line"># 注意这一功能需要系统上已有 ssh 命令，且必须使用 ssh public key authentication</span><br><span class="line">#</span><br><span class="line"># 若指定该选项，COW 将执行以下命令：</span><br><span class="line">#     ssh -n -N -D &lt;local_socks_port&gt; -p &lt;server_ssh_port&gt; &lt;user@server&gt;</span><br><span class="line"># server_ssh_port 端口不指定则默认为 22</span><br><span class="line"># 如果要指定其他 ssh 选项，请修改 ~/.ssh/config</span><br><span class="line">#sshServer = user@server:local_socks_port[:server_ssh_port]</span><br><span class="line"></span><br><span class="line">#############################</span><br><span class="line"># 认证</span><br><span class="line">#############################</span><br><span class="line"></span><br><span class="line"># 指定允许的 IP 或者网段。网段仅支持 IPv4，可以指定 IPv6 地址，用逗号分隔多个项</span><br><span class="line"># 使用此选项时别忘了添加 127.0.0.1，否则本机访问也需要认证</span><br><span class="line">#allowedClient = 127.0.0.1, 192.168.1.0/24, 10.0.0.0/8</span><br><span class="line"></span><br><span class="line"># 要求客户端通过用户名密码认证</span><br><span class="line"># COW 总是先验证 IP 是否在 allowedClient 中，若不在其中再通过用户名密码认证</span><br><span class="line">#userPasswd = username:password</span><br><span class="line"></span><br><span class="line"># 如需指定多个用户名密码，可在下面选项指定的文件中列出，文件中每行内容如下</span><br><span class="line">#   username:password[:port]</span><br><span class="line"># port 为可选项，若指定，则该用户只能从指定端口连接 COW</span><br><span class="line"># 注意：如有重复用户，COW 会报错退出</span><br><span class="line">#userPasswdFile = /path/to/file</span><br><span class="line"></span><br><span class="line"># 认证失效时间</span><br><span class="line"># 语法：2h3m4s 表示 2 小时 3 分钟 4 秒</span><br><span class="line">#authTimeout = 2h</span><br><span class="line"></span><br><span class="line">#############################</span><br><span class="line"># 高级选项</span><br><span class="line">#############################</span><br><span class="line"></span><br><span class="line"># 将指定的 HTTP error code 认为是被干扰，使用二级代理重试，默认为空</span><br><span class="line">#httpErrorCode =</span><br><span class="line"></span><br><span class="line"># 最多允许使用多少个 CPU 核</span><br><span class="line">#core = 2</span><br><span class="line"></span><br><span class="line"># 检测超时时间使用的网站，最好使用能快速访问的站点</span><br><span class="line">#estimateTarget = example.com</span><br><span class="line"></span><br><span class="line"># 允许建立隧道连接的端口，多个端口用逗号分隔，可重复多次</span><br><span class="line"># 默认总是允许下列服务的端口: ssh, http, https, rsync, imap, pop, jabber, cvs, git, svn</span><br><span class="line"># 如需允许其他端口，请用该选项添加</span><br><span class="line"># 限制隧道连接的端口可以防止将运行 COW 的服务器上只监听本机 ip 的服务暴露给外部</span><br><span class="line">#tunnelAllowedPort = 80, 443</span><br><span class="line"></span><br><span class="line"># GFW 会使 DNS 解析超时，也可能返回错误的地址，能连接但是读不到任何内容</span><br><span class="line"># 下面两个值改小一点可以加速检测网站是否被墙，但网络情况差时可能误判</span><br><span class="line"></span><br><span class="line"># 创建连接超时（语法跟 authTimeout 相同）</span><br><span class="line">#dialTimeout = 5s</span><br><span class="line"># 从服务器读超时</span><br><span class="line">#readTimeout = 5s</span><br><span class="line"></span><br><span class="line"># 基于 client 是否很快关闭连接来检测 SSL 错误，只对 Chrome 有效</span><br><span class="line"># （Chrome 遇到 SSL 错误会直接关闭连接，而不是让用户选择是否继续）</span><br><span class="line"># 可能将可直连网站误判为被墙网站，当 GFW 进行 SSL 中间人攻击时可以考虑使用</span><br><span class="line">#detectSSLErr = false</span><br><span class="line"></span><br><span class="line"># 修改 stat/blocked/direct 文件路径，如不指定，默认在配置文件所在目录下</span><br><span class="line"># 执行 cow 的用户需要有对 stat 文件所在目录的写权限才能更新 stat 文件</span><br><span class="line">#statFile = &lt;dir to rc file&gt;/stat</span><br><span class="line">#blockedFile = &lt;dir to rc file&gt;/blocked</span><br><span class="line">#directFile = &lt;dir to rc file&gt;/direct</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhaodaxin.com/2017/02/20/2017-02-20-COW-Climb-Over-the-Wall-Proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="3Golds">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/gophers.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="3Golds">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/20/2017-02-20-COW-Climb-Over-the-Wall-Proxy/" itemprop="url">COW (Climb Over the Wall) Proxy</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-20T00:00:00+08:00">
                2017-02-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/02/20/2017-02-20-COW-Climb-Over-the-Wall-Proxy/" class="leancloud_visitors" data-flag-title="COW (Climb Over the Wall) Proxy">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,171
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="COW简介"><a href="#COW简介" class="headerlink" title="COW简介"></a>COW简介</h3><blockquote>
<p><code>COW</code> 是一个简化穿墙的 <code>HTTP 代理服务器</code>。它能自动检测被墙网站，仅对这些网站使用<code>二级代理</code>。COW对外提供一个地址和端口，用户只需将这个地址配置好，便可以使用。COW的二级代理用来访问海外的server，支持<code>sock5</code>、<code>shadowsocks</code>、<code>cow</code>(采用shadowsock协议)三种方式. <a href="https://github.com/cyfdecyf/cow" target="_blank" rel="noopener">Github地址</a></p>
</blockquote>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><p>COW 的设计目标是自动化，理想情况下用户无需关心哪些网站无法访问，可直连网站也不会因为使用二级代理而降低访问速度。</p>
<ul>
<li><p>作为 HTTP 代理，可提供给移动设备使用；若部署在国内服务器上，可作为 APN 代理</p>
</li>
<li><p>支持 HTTP, SOCKS5, shadowsocks 和 cow 自身作为二级代理</p>
</li>
<li><p>可使用多个二级代理，支持简单的负载均衡</p>
</li>
<li><p>自动检测网站是否被墙，仅对被墙网站使用二级代理</p>
</li>
<li><p>自动生成包含直连网站的 PAC，访问这些网站时可绕过 COW</p>
</li>
<li><p>内置常见可直连网站，如国内社交、视频、银行、电商等网站（可手工添加）</p>
</li>
</ul>
<h3 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h3><h4 id="1-OS-X-Linux-x86-ARM-执行以下命令（也可用于更新）"><a href="#1-OS-X-Linux-x86-ARM-执行以下命令（也可用于更新）" class="headerlink" title="1. OS X, Linux (x86, ARM): 执行以下命令（也可用于更新）"></a><strong>1. OS X, Linux (x86, ARM)</strong>: 执行以下命令（也可用于更新）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L git.io/cow | bash</span><br><span class="line"># 环境变量 `COW_INSTALLDIR` 可以指定安装的路径，若该环境变量不是目录则询问用户</span><br></pre></td></tr></table></figure>
<h4 id="2-Windows-从-release-页面下载"><a href="#2-Windows-从-release-页面下载" class="headerlink" title="2.Windows: 从 release 页面下载"></a><strong>2.Windows</strong>: 从 <a href="https://github.com/cyfdecyf/cow/releases" target="_blank" rel="noopener">release</a> 页面下载</h4><h4 id="3-熟悉-Go-的用户可用-go-get-github-com-cyfdecyf-cow-从源码安装"><a href="#3-熟悉-Go-的用户可用-go-get-github-com-cyfdecyf-cow-从源码安装" class="headerlink" title="3.熟悉 Go 的用户可用 go get github.com/cyfdecyf/cow 从源码安装"></a><strong>3.熟悉 Go 的用户可用 go get github.com/cyfdecyf/cow 从源码安装</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/cyfdecyf/cow</span><br></pre></td></tr></table></figure>
<h3 id="二、配置"><a href="#二、配置" class="headerlink" title="二、配置"></a>二、配置</h3><p><strong>编辑 ~/.cow/rc (Linux) 或 rc.txt (Windows)，简单的配置例子如下</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#开头的行是注释，会被忽略</span><br><span class="line"></span><br><span class="line"># 本地 HTTP 代理地址</span><br><span class="line"></span><br><span class="line"># 配置 HTTP 和 HTTPS 代理时请填入该地址</span><br><span class="line"></span><br><span class="line"># 若配置代理时有对所有协议使用该代理的选项，且你不清楚此选项的含义，请勾选</span><br><span class="line"></span><br><span class="line"># 或者在自动代理配置中填入 http://127.0.0.1:7777/pac</span><br><span class="line"></span><br><span class="line">listen = http://127.0.0.1:7777</span><br><span class="line"></span><br><span class="line"># SOCKS5 二级代理 用来连接socks5</span><br><span class="line"></span><br><span class="line">proxy = socks5://127.0.0.1:1080</span><br><span class="line"></span><br><span class="line"># HTTP 二级代理 用来连接其他的http代理</span><br><span class="line"></span><br><span class="line">proxy = http://127.0.0.1:8080</span><br><span class="line"></span><br><span class="line">proxy = http://user:password@127.0.0.1:8080</span><br><span class="line"></span><br><span class="line"># shadowsocks 二级代理 用来连接ss代理</span><br><span class="line"></span><br><span class="line">proxy = ss://aes-128-cfb:password@1.2.3.4:8388</span><br><span class="line"></span><br><span class="line"># cow 二级代理 用来连接cow的二级代理</span><br><span class="line"></span><br><span class="line">proxy = cow://aes-128-cfb:password@1.2.3.4:8388</span><br></pre></td></tr></table></figure>
<p><strong>使用 cow 协议的二级代理需要在国外服务器上安装 COW，并使用如下配置：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen = cow://aes-128-cfb:password@0.0.0.0:8388</span><br></pre></td></tr></table></figure>
<p>完成配置后启动 COW 并配置好代理即可使用。</p>
<h3 id="三、启动COW"><a href="#三、启动COW" class="headerlink" title="三、启动COW"></a>三、启动COW</h3><p><strong>配置文件在 Unix 系统上为 ~/.cow/rc，Windows 上为 COW 所在目录的 rc.txt 文件。 <a href="http://zantony.top/2017/02/20/Cow-rc-%E6%A0%B7%E4%BE%8B%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" target="_blank" rel="noopener">样例配置</a> 包含了所有选项以及详细的说明，建议下载然后修改。</strong></p>
<ul>
<li><strong>Unix 系统在命令行上执行 cow &amp; (若 COW 不在 PATH 所在目录，请执行 ./cow &amp;)</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cow -rc=rc  -v  -debug &amp; # 可先开启debug模式测试</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>Windows</strong></p>
<ul>
<li><p>双击 cow-taskbar.exe，隐藏到托盘执行</p>
</li>
<li><p>双击 cow-hide.exe，隐藏为后台程序执行</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>以上两者都会启动 cow.exe</p>
</blockquote>
<blockquote>
<p>PAC url 为 http://<listen address="">/pac，也可将浏览器的 HTTP/HTTPS 代理设置为 listen address 使所有网站都通过 COW 访问。</listen></p>
</blockquote>
<p><strong>使用 PAC 可获得更好的性能，但若 PAC 中某网站从直连变成被封，浏览器会依然尝试直连。遇到这种情况可以暂时不使用 PAC 而总是走 HTTP 代理，让 COW 学习到新的被封网站。命令行选项可以覆盖部分配置文件中的选项、打开 debug/request/reply 日志，执行 cow -h 来获取更多信息。</strong></p>
<h3 id="四、客户端配置"><a href="#四、客户端配置" class="headerlink" title="四、客户端配置"></a>四、客户端配置</h3><h4 id="1-Firefox配置"><a href="#1-Firefox配置" class="headerlink" title="1.Firefox配置"></a>1.Firefox配置</h4><p>首选项–&gt;高级–&gt;网络–&gt;设置<br><img src="http://obbogqhb1.bkt.clouddn.com/firefox.png" alt="firefox"></p>
<h4 id="2-Chrom和mac配置"><a href="#2-Chrom和mac配置" class="headerlink" title="2.Chrom和mac配置"></a>2.Chrom和mac配置</h4><p>网络–&gt;选择网络–&gt;高级–&gt;代理<br><img src="http://obbogqhb1.bkt.clouddn.com/mac1.png" alt="mac"><br><img src="http://obbogqhb1.bkt.clouddn.com/mac2.png" alt="mac2"></p>
<h3 id="五、手动指定被墙和直连网站"><a href="#五、手动指定被墙和直连网站" class="headerlink" title="五、手动指定被墙和直连网站"></a>五、手动指定被墙和直连网站</h3><p>一般情况下无需手工指定被墙和直连网站，该功能只是是为了处理特殊情况和性能优化。</p>
<p>配置文件所在目录下的 blocked 和 direct 可指定被墙和直连网站（direct 中的 host 会添加到 PAC）。 Windows 下文件名为 blocked.txt 和 direct.txt。</p>
<ul>
<li><p>每行一个域名或者主机名（COW 会先检查主机名是否在列表中，再检查域名）</p>
<ul>
<li><p>二级域名如 google.com 相当于 *.google.com</p>
</li>
<li><p>com.hk, edu.cn 等二级域名下的三级域名，作为二级域名处理。如 google.com.hk 相当于 *.google.com.hk</p>
</li>
<li><p>其他三级及以上域名/主机名做精确匹配，例如 plus.google.com</p>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/gophers.jpg"
                alt="3Golds" />
            
              <p class="site-author-name" itemprop="name">3Golds</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/3Golds" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:go80800@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">3Golds</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  









  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  
    

    
  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("bK3mQMcoKlwuLljKCOH5tsP1-gzGzoHsz", "343DJUSwdwM3miekBuwdNf24");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({});</script></body>
</html>
